{% extends "base.html" %}
{% block title %}
  Cuecards | StudySlate
{% endblock
title %}
{% block styles %}
  <link rel="stylesheet"
        href="{{ url_for('static', filename='styles/dashboard.css') }}" />
  <link rel="stylesheet"
        href="{{ url_for('static', filename='styles/cuecards.css') }}" />
{% endblock styles %}
{% block content %}
  <div class="d-flex flex-nowrap vh-100">
    <div class="d-flex flex-column flex-shrink-0 p-3 sidebar"
         style="width: 280px">
      <a href="/"
         class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
        <span class="fs-4 fw-bold">StudySlate</span>
      </a>
      <p class="m-0" id="class-name">Loading...</p>
      <hr />
      <ul id="classes-list" class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a href="/class/{{ class_id }}" class="nav-link">Home</a>
        </li>
        <li class="nav-item">
          <a href="/class/{{ class_id }}/notebook" class="nav-link">Notebook</a>
        </li>
        <li class="nav-item">
          <a href="/class/{{ class_id }}/cuecards" class="nav-link active">Cue Cards</a>
        </li>
        <li class="nav-item">
          <a href="/class/{{ class_id }}/todo" class="nav-link">To Do</a>
        </li>
        <li class="nav-item">
          <a href="/class/{{ class_id }}/assignments" class="nav-link">Assignments</a>
        </li>
        <li class="nav-item">
          <a href="/class/{{ class_id }}/lockin" class="nav-link">Lock In Timer</a>
        </li>
        <hr />
        <li class="nav-item">
          <a href="/dashboard" class="nav-link"><i class="bi bi-arrow-left pe-3"></i> Back</a>
        </li>
      </ul>
      <hr />
      <div class="dropdown">
        <a href="#"
           class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
           data-bs-toggle="dropdown"
           aria-expanded="false">
          <strong>Manage Account</strong>
        </a>
        <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
          <li>
            <a class="dropdown-item" href="/logout">Log out</a>
          </li>
        </ul>
      </div>
    </div>
    <div class="flex-grow-1 d-flex flex-column">
      <div class="todo-header d-flex justify-content-between align-items-center p-3">
        <h1>Cue Cards</h1>
        <button class="add-todo-btn"
                data-bs-toggle="modal"
                data-bs-target="#add-set-modal">New Set</button>
      </div>
      <div class="flex-grow-1 p-3" style="overflow-y: auto">
        <div id="sets-container" class="todo-container"></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="add-set-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-center position-relative">
          <h4 class="modal-title text-center">Create a New Set</h4>
          <button type="button"
                  class="btn-close position-absolute end-0 me-3"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Name of the cue card set</p>
          <form id="add-set-form">
            <input type="text"
                   maxlength="100"
                   class="form-control"
                   placeholder="Enter the name..."
                   required />
          </form>
          <div id="todo-error"
               class="text-danger text-center mt-3"
               style="display: none"></div>
        </div>
        <div class="modal-footer justify-content-center" style="border-top: none">
          <button type="submit" form="add-set-form" class="btn btn-success">Add Set</button>
        </div>
      </div>
    </div>
  </div>
  <script>
  const classId = "{{ class_id }}";
  let sets = [];
  let isLoading = true;

  function renderSets() {
    const container = document.getElementById("sets-container");
    if (isLoading) {
      container.innerHTML = '<div class="loading">Loading cue card sets...</div>';
      return;
    }
    container.innerHTML =
      sets
        .map(
          (set) => `
      <a href="/class/${classId}/cuecards/${set.id}" class="todo-section">
        <div class="set-title">${set.name}</div>
        <div class="set-card-number">0 Cards</div>
      </a>
    `
        )
        .join("") +
      `
      <a data-bs-toggle="modal" data-bs-target="#add-set-modal" class="todo-section-create todo-section">
        <div class="set-title-icon">
          <i class="bi bi-plus-circle-fill"></i>
        </div>
        <div class="set-card-number">Create New Set</div>
      </a>
    `;
  }

  async function loadClass() {
    try {
      const response = await fetch(`/api/classes/${classId}`);
      if (!response.ok) throw new Error("Failed to fetch class");
      const cls = await response.json();
      document.getElementById("class-name").textContent = cls.name;
    } catch (error) {
      console.error("Error loading class:", error);
      document.getElementById("class-name").textContent = "Class not found";
    }
  }

  async function loadSets() {
    try {
      const response = await fetch(`/api/classes/${classId}/cuecard_sets`);
      if (!response.ok) throw new Error("Failed to fetch sets");
      sets = await response.json();
    } catch (error) {
      console.error("Error loading sets:", error);
    } finally {
      isLoading = false;
      renderSets();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadClass();
    renderSets();
    loadSets();
  });

  document
    .getElementById("add-set-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = e.target.querySelector("input").value.trim();
      if (!name) return;
      try {
        const response = await fetch(`/api/classes/${classId}/cuecard_sets`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name }),
        });
        if (!response.ok) throw new Error("Failed to create set");
        e.target.querySelector("input").value = "";
        bootstrap.Modal.getInstance(
          document.getElementById("add-set-modal")
        ).hide();
        loadSets();
      } catch (error) {
        console.error("Error creating set:", error);
        document.getElementById("todo-error").textContent = error.message;
        document.getElementById("todo-error").style.display = "block";
      }
    });
  </script>
{% endblock content %}
