{% extends "base.html" %}
{% block title %}
  Notebook | StudySlate
{% endblock
title %}
{% block styles %}
  <link rel="stylesheet"
        href="{{ url_for('static', filename='styles/dashboard.css') }}" />
{% endblock styles %}
{% block content %}
  <div class="d-flex flex-nowrap vh-100">
    <div class="d-flex flex-column flex-shrink-0 p-3 sidebar"
         style="width: 280px">
      <a href="/"
         class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
        <span class="fs-4 fw-bold">StudySlate</span>
      </a>
      <p class="m-0" id="class-name">Loading...</p>
      <hr />
      <ul id="classes-list" class="nav nav-pills flex-column mb-auto">
        <div id="note-holder"></div>
        <hr />
        <li class="nav-item">
          <a href="#" onclick="createNote(); return false;" class="nav-link"><i class="bi bi-plus-lg pe-3"></i> New Note</a>
        </li>
        <li class="nav-item">
          <a href="/class/{{ class_id }}" class="nav-link"><i class="bi bi-arrow-left pe-3"></i> Back</a>
        </li>
      </ul>
      <hr />
      <div class="dropdown">
        <a href="#"
           class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
           data-bs-toggle="dropdown"
           aria-expanded="false">
          <strong>email</strong>
        </a>
        <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
          <li>
            <a class="dropdown-item" href="/logout">Log out</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <script>
  const classId = "{{ class_id }}";
  let notes = [];
  let isLoading = true;

  function renderNotes() {
    const list = document.getElementById("note-holder");
    if (isLoading) {
      list.innerHTML = '<div class="loading">Loading notes...</div>';
      return;
    }
    list.innerHTML = "";
    notes.forEach((note) => {
      const li = document.createElement("li");
      li.className = "nav-item";

      const a = document.createElement("a");
      a.href = `/class/${classId}/notebook/${note.id}`;
      a.className = "nav-link";
      a.textContent = note.title;

      li.appendChild(a);

      list.appendChild(li);
    });
  }

  async function loadClass() {
    try {
      const response = await fetch(`/api/classes/${classId}`);
      if (!response.ok) throw new Error("Failed to fetch class");
      const cls = await response.json();
      document.getElementById("class-name").textContent = cls.name;
    } catch (error) {
      console.error("Error loading class:", error);
      document.getElementById("class-name").textContent = "Class not found";
    }
  }

  async function loadNotes() {
    try {
      const response = await fetch(`/api/classes/${classId}/notes`);
      if (!response.ok) throw new Error("Failed to fetch notes");
      notes = await response.json();
    } catch (error) {
      console.error("Error loading notes:", error);
    } finally {
      isLoading = false;
      renderNotes();
    }
  }

  async function createNote() {
    try {
      const response = await fetch(`/api/classes/${classId}/notes`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title: 'Untitled'})
      });
      if (response.ok) {
        const note = await response.json();
        window.location.href = `/class/${classId}/notebook/${note.id}`;
      }
    } catch (error) {
      console.error("Error creating note:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadClass();
    renderNotes();
    loadNotes();
  });
  </script>
{% endblock content %}
