{% extends "base.html" %} {% block title %} Sign Up | StudySlate {% endblock
title %} {% block styles %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='styles/login.css') }}"
/>
{% endblock styles %} {% block content %}
<header class="d-flex flex-wrap justify-content-center py-3 border-bottom px-5">
  <a
    href="/"
    class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none"
  >
    <span class="fs-4">StudySlate</span>
  </a>
  <ul class="nav nav-pills">
    <li class="nav-item">
      <a href="/login" class="nav-link active" aria-current="page">Login</a>
    </li>
    <li class="nav-item">
      <a href="#" class="nav-link">Features</a>
    </li>
  </ul>
</header>
<div
  class="d-flex justify-content-center align-items-start pt-3"
  style="height: 92vh"
>
  <div
    class="card px-5 pb-5 shadow-lg"
    style="max-width: 500px; border-radius: 15px"
  >
    <h1 class="text-center mt-5">Lock In with StudySlate</h1>
    <p class="text-center mb-4">Enter your email to sign up</p>
    <form id="auth-form" class="d-flex flex-column align-items-center">
      <input
        type="email"
        id="email"
        placeholder="Enter your email"
        class="form-control mb-3"
        style="max-width: 300px"
        required
      />
      <button type="submit" id="send-code-btn" class="btn btn-primary">
        <span
          class="spinner-border spinner-border-sm d-none"
          role="status"
          aria-hidden="true"
        ></span>
        Send Code
      </button>
    </form>
    <div
      id="error-message"
      class="text-danger text-center mt-3"
      style="display: none"
    ></div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="code-modal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div
      class="modal-content"
      style="box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4)"
    >
      <div class="modal-header d-flex justify-content-center position-relative">
        <h4 class="modal-title text-center">Enter Your 8-Digit Code</h4>
        <button
          type="button"
          class="btn-close position-absolute end-0 me-3"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-center" style="padding: 0.75rem 1.5rem">
        <p>Check your email for the code.</p>
        <form id="code-form" class="d-flex justify-content-center">
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
          <input
            type="text"
            maxlength="1"
            class="code-input form-control mx-1"
            style="width: 40px"
            required
          />
        </form>
        <div
          id="verify-error"
          class="text-danger text-center mt-3"
          style="display: none"
        ></div>
      </div>
      <div class="modal-footer justify-content-center" style="border-top: none">
        <button
          type="submit"
          form="code-form"
          id="verify-btn"
          class="btn btn-success"
        >
          <span
            class="spinner-border spinner-border-sm d-none"
            role="status"
            aria-hidden="true"
          ></span>
          Verify
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  function setButtonLoading(button, isLoading) {
    const spinner = button.querySelector(".spinner-border");
    if (isLoading) {
      button.disabled = true;
      spinner.classList.remove("d-none");
    } else {
      button.disabled = false;
      spinner.classList.add("d-none");
    }
  }

  document
    .getElementById("auth-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const errorDiv = document.getElementById("error-message");
      const button = document.getElementById("send-code-btn");
      errorDiv.style.display = "none";
      setButtonLoading(button, true);

      try {
        const response = await fetch("/send-code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const data = await response.json();
        if (data.success) {
          const modal = new bootstrap.Modal(
            document.getElementById("code-modal")
          );
          modal.show();
          setTimeout(() => document.querySelector(".code-input").focus(), 100);
        } else {
          errorDiv.textContent = data.error;
          errorDiv.style.display = "block";
        }
      } catch (err) {
        errorDiv.textContent = "An error occurred.";
        errorDiv.style.display = "block";
      } finally {
        setButtonLoading(button, false);
      }
    });

  const codeInputs = document.querySelectorAll(".code-input");
  codeInputs.forEach((input, index) => {
    input.addEventListener("keydown", (e) => {
      const allowedKeys = [
        "Backspace",
        "Delete",
        "ArrowLeft",
        "ArrowRight",
        "Tab",
      ];
      if (!/^\d$/.test(e.key) && !allowedKeys.includes(e.key)) {
        e.preventDefault();
      }
      if (e.key === "Backspace" && input.value === "" && index > 0) {
        codeInputs[index - 1].focus();
      }
    });

    input.addEventListener("input", () => {
      if (
        input.value &&
        /^\d$/.test(input.value) &&
        index < codeInputs.length - 1
      ) {
        codeInputs[index + 1].focus();
      }
    });

    input.addEventListener("focus", () => {
      input.select();
    });
  });

  document
    .getElementById("code-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const inputs = document.querySelectorAll(".code-input");
      const code = Array.from(inputs)
        .map((input) => input.value)
        .join("");
      const email = document.getElementById("email").value;
      const errorDiv = document.getElementById("verify-error");
      const button = document.getElementById("verify-btn");
      errorDiv.style.display = "none";
      setButtonLoading(button, true);

      try {
        const response = await fetch("/verify-code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code }),
        });
        const data = await response.json();
        if (data.success) {
          window.location.href = "/dashboard";
        } else {
          errorDiv.textContent = data.error;
          errorDiv.style.display = "block";
        }
      } catch (err) {
        errorDiv.textContent = "An error occurred.";
        errorDiv.style.display = "block";
      } finally {
        setButtonLoading(button, false);
      }
    });
</script>
<footer
  class="d-flex flex-wrap justify-content-between align-items-center py-3 px-5 my-4 border-top"
>
  <p class="col-md-4 mb-0 text-body-secondary">&copy; 2025 StudySlate</p>
  <a
    href="/"
    class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none"
    aria-label="Bootstrap"
  >
    <svg class="bi me-2" width="40" height="32" aria-hidden="true">
      <use xlink:href="#bootstrap"></use>
    </svg>
  </a>
  <ul class="nav col-md-4 justify-content-end">
    <li class="nav-item">
      <a href="#" class="nav-link px-2 text-body-secondary">Home</a>
    </li>
    <li class="nav-item">
      <a href="#" class="nav-link px-2 text-body-secondary">Features</a>
    </li>
    <li class="nav-item">
      <a href="#" class="nav-link px-2 text-body-secondary">Pricing</a>
    </li>
    <li class="nav-item">
      <a href="#" class="nav-link px-2 text-body-secondary">FAQs</a>
    </li>
    <li class="nav-item">
      <a href="#" class="nav-link px-2 text-body-secondary">About</a>
    </li>
  </ul>
</footer>
{% endblock content %}
